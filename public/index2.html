<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Assistant AI - Aninka Fashion</title>
    <style>
      body {
        font-family: system-ui, Arial, sans-serif;
        margin: 0;
        background: #f7f7f8;
        color: #111;
      }
      header {
        display: flex;
        align-items: center;
       justify-content: space-between;
         padding: 16px 1rem;
        background-color: rgb(243 244 246 / var(--tw-bg-opacity, 1));
        color: hsl(var(--foreground));
        border-bottom: 1px solid #e5e7eb;
      }

      header .left {
        display: flex;
        align-items: center;
        gap: 6px; /* jarak panah & title */
      }

      header .title {
        font-size: 18px;
        font-weight: bold;
      }

      header .back-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        color: #4b5563;
        text-decoration: none;
        transition: background 0.2s, color 0.2s;
      }

      #clear {
        background: rgb(240, 82, 82);
        border: none;
        padding: 4px;
        border-radius: 6px;
        cursor: pointer;
      }

    
  
      header .back-btn:hover {
        background: #e5e7eb; /* gray-200 */
        color: #2563eb; /* blue-600 */
      }

      header .back-btn svg {
        width: 16px;
        height: 16px;
      }

      main {
        max-width: 840px;
        margin: 0 auto;
        padding: 12px;
      }
      .chat {
        background: #fff;
        border: 1px solid #e6e6e6;
        border-radius: 12px;
        padding: 16px;
        height: 70vh;
        overflow-y: auto;
      }
      .msg {
        margin: 8px 0;
        padding: 10px 12px;
        border-radius: 10px;
        max-width: 80%;
      }
      .user {
        background: #e9f5ff;
        margin-left: auto;
      }
      .assistant {
        background: #f2f2f2;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 12px;
        margin-top: 5px;
      }
      .card {
        border: 1px solid #eee;
        border-radius: 5px;
        overflow: hidden;
        background: #fff;
      }
      .card img {
        width: 100%;
        height: 160px;
        object-fit: cover;
        background: #fafafa;
      }
      .card .info {
        padding: 8px 10px;
      }
      .price {
        font-weight: 700;
      }
      .sizes {
        margin-top: 4px;
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }
      .size-badge {
        background: #f3f4f6;
        color: #111827;
        border: 1px solid #e5e7eb;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 12px;
      }
      form {
        display: flex;
        gap: 8px;
        margin-top: 12px;
      }
      .input-wrap {
        position: relative;
        flex: 1;
        display: flex;
      }
      input[type="text"] {
        flex: 1;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid #ccc;
      }
      button {
        padding: 12px 16px;
        border-radius: 10px;
        border: none;
        background: #111;
        color: #fff;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
     .suggestions {
  display: none;
  position: absolute;
  left: 0;
  right: 0;
  bottom: calc(100% + 10px);
  align-items: flex-start; /* biar bubble nempel kiri */
  display: flex;               /* pakai flex */
  flex-direction: column;      
  gap: 8px;                    /* jarak antar bubble */
  background: transparent;     /* hapus background kotak besar */
  border: none;                /* hilangkan border kotak besar */
  box-shadow: none;            /* hilangkan shadow utama */
  z-index: 50;
}

.suggestion-item {
  background: #ffffff;
  padding: 10px;
  border-radius: 20px;
  box-shadow: 0 4px 10px rgba(225, 224, 224, 0.08);
  cursor: pointer;
  transition: background 0.2s, transform 0.15s;
}

.suggestion-item:hover {
  background: #f9fafb;
  transform: translateY(-2px); /* efek bubble naik sedikit */
}
      .note {
        font-size: 12px;
        color: #666;
        margin-top: 8px;
      }
      .info-box {
        background: #e8f4fd;
        border: 1px solid #bee5eb;
        border-radius: 8px;
        padding: 12px;
        margin-top: 8px;
      }
      .info-box h4 {
        margin: 0 0 8px 0;
        color: #0c5460;
      }
      .info-box pre {
        margin: 0;
        white-space: pre-wrap;
        font-family: inherit;
        white-space: pre-wrap; /* biar tetap jaga line break tapi bisa wrap */
        word-wrap: break-word; /* support browser lama */
        overflow-wrap: anywhere;
        max-width: 100%; /* biar nggak melebar keluar */
        overflow-x: auto;
      }
      .faq-box {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 5px;
        padding: 12px;
        margin-top: 5px;

        /* ini penting untuk teks panjang */
        word-wrap: break-word; /* untuk browser lama */
        overflow-wrap: anywhere; /* modern, lebih fleksibel */
        white-space: pre-wrap; /* jaga line break & wrap teks */
      }
      .faq-box h4 {
        margin: 0 0 5px 0;
        color: #856404;
      }
      .faq-box pre {
        margin: 0;
        white-space: pre-wrap;
        font-family: inherit;
        white-space: pre-wrap; /* biar tetap jaga line break tapi bisa wrap */
        word-wrap: break-word; /* support browser lama */
        overflow-wrap: anywhere;
        max-width: 100%; /* biar nggak melebar keluar */
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="left">
        
        <a
          href="https://aninkafashion.com/home"
          class="back-btn"
          title="Back to List"
        >
          <!-- SVG panah kiri -->
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"
            />
          </svg>
        </a>
        <div class="title">Assistant Chatbot</div>
      </div>

      <button
        id="clear"
        type="button"
        style="
          background: rgb(240, 82, 82);
          border: none;
          padding: 4px;
          border-radius: 6px;
          cursor: pointer;
        "
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          fill="#fff"
          viewBox="0 0 24 24"
        >
          <path
            d="M9 3v1H4v2h16V4h-5V3H9zm2 6v10h2V9h-2zm-4 0v10h2V9H7zm8 0v10h2V9h-2z"
          />
        </svg>
      </button>
    </header>
    <main>
      <div class="chat" id="chat"></div>
      <form id="form">
        <div class="input-wrap">
          <input
            id="input"
            type="text"
            placeholder="Tulis pertanyaan Anda..."
            autocomplete="off"
          />
        </div>
        
        <div style="display: flex; gap: 8px">
          <button
            type="submit"
            style="
              background: #28a745;
              border: none;
              padding: 8px 12px;
              border-radius: 6px;
              cursor: pointer;
              color: #fff;
              display: flex;
              align-items: center;
              gap: 6px;
            "
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              fill="#fff"
              viewBox="0 0 24 24"
            >
              <path d="M2 21l21-9L2 3v7l15 2-15 2v7z" />
            </svg>
          </button>
        </div>
      </form>
      <div class="note">
        Bahasa utama: Indonesia. Contoh: "Ada gamis dress brokat warna krem?"
      </div>
    </main>
     <div style="display: none;" id="tokenBox"></div>
    <script>
      const chat = document.getElementById("chat");
      const form = document.getElementById("form");
      const input = document.getElementById("input");
      const STORAGE_KEY = "aninkaChatMessages";
      const TOKEN_KEY = "aninkafashion-token";

      // Ambil token dari cookie, lalu simpan ke localStorage
      // Get the current URL
      const url = new URL(window.location.href);

      // Get the value of the '_token' query parameter
      const tokenFromUrl = url.searchParams.get('_token');

      // Log and store the token if it exists
      if (tokenFromUrl) {
        localStorage.setItem('aninkafashion-token', tokenFromUrl);
        // document.cookie = `aninkafashion-token=${tokenFromUrl}; expires=${expirationDate.toUTCString()}; path=/`;
        console.log("Token from URL:", tokenFromUrl);
      } else {
        console.log("No token found in URL.");
      }

      if (url.searchParams.has('_token')) {
        // Hapus parameter '_token'
        url.searchParams.delete('_token');

        // Ganti URL di browser tanpa me-refresh halaman
        window.history.replaceState({}, document.title, url.toString());

        console.log("URL token berhasil dihapus.");
      }

      function getClientAuthHeaders() {
          const token = localStorage.getItem('aninkafashion-token');
          const headers = {
            'Content-Type': 'application/json',
          };
          
          // Jika token ada di localStorage, tambahkan ke header otorisasi
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }
          
          return headers;
        }

      function defaultConversation() {
        return [
          {
            role: "assistant",
            content:
              "Halo!! Saya asisten AI Aninka Fashion. Ada yang bisa saya bantu?",
          },
        ];
      }
      let messages = [];
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        messages = saved ? JSON.parse(saved) : defaultConversation();
        if (!Array.isArray(messages) || messages.length === 0)
          messages = defaultConversation();
      } catch {
        messages = defaultConversation();
      }

      function render() {
        chat.innerHTML = "";
        for (const m of messages) {
          const div = document.createElement("div");
          div.className = `msg ${m.role === "user" ? "user" : "assistant"}`;
          const p = document.createElement("div");
          p.innerHTML = m.content;
          div.appendChild(p);

          // Display products grid
          if (m.products && m.products.length) {
            const grid = document.createElement("div");
            grid.className = "grid";
            m.products.forEach((prod) => {
              const card = document.createElement("div");
              card.className = "card";

              const img = document.createElement("img");
              img.src = prod.imageUrl || "";
              img.alt = prod.name || "";

              const info = document.createElement("div");
              info.className = "info";

              const name = document.createElement("div");
              name.textContent = prod.name || "";

              const price = document.createElement("div");
              price.className = "price";
              price.textContent = prod.price ? `Rp${prod.price}` : "";

              // description dari API (HTML)
              if (prod.description) {
                const desc = document.createElement("div");
                desc.className = "description";
                desc.innerHTML = prod.description; // render HTML <p>...</p>
                info.appendChild(desc);
              }

              const cat = document.createElement("div");
              cat.className = "cat";
              cat.textContent = prod.category || "";

              const color = document.createElement("div");
              color.className = "color";
              if (prod.color) color.textContent = prod.color;
              const sizes = document.createElement("div");
              sizes.className = "sizes";
              if (Array.isArray(prod.sizes) && prod.sizes.length) {
                prod.sizes.forEach(s => {
                  const badge = document.createElement("span");
                  badge.className = "size-badge";
                  const qty = s.qty_available != null ? ` (${s.qty_available})` : "";
                  badge.textContent = `${s.label || ""}${qty}`;
                  sizes.appendChild(badge);
                });
              }
              info.appendChild(name);
              info.appendChild(price);
              info.appendChild(cat);
              if (prod.color) info.appendChild(color);
              if (sizes.childElementCount) info.appendChild(sizes);
              card.appendChild(img);
              card.appendChild(info);
              grid.appendChild(card);
            });
            div.appendChild(grid);
          }

          // Display order info
          if (m.orderInfo) {
            const orderBox = document.createElement("div");
            orderBox.className = "info-box";
            const orderTitle = document.createElement("h4");
            orderTitle.textContent = "📦 Informasi Order";
            const orderContent = document.createElement("pre");
            orderContent.textContent = m.orderInfo.fullText;
            orderBox.appendChild(orderTitle);
            orderBox.appendChild(orderContent);
            div.appendChild(orderBox);
          }

          // Display tracking info
          if (m.trackingInfo) {
            const trackBox = document.createElement("div");
            trackBox.className = "info-box";
            const trackTitle = document.createElement("h4");
            trackTitle.textContent = "🚚 Status Pengiriman";
            const trackContent = document.createElement("pre");
            trackContent.textContent = m.trackingInfo.fullText;
            trackBox.appendChild(trackTitle);
            trackBox.appendChild(trackContent);
            div.appendChild(trackBox);
          }

          // Display FAQ info
          if (m.faqInfo) {
            const faqBox = document.createElement("div");
            faqBox.className = "faq-box";
            const faqTitle = document.createElement("h4");
            faqTitle.textContent = `❓ ${m.faqInfo.title}`;
            const faqContent = document.createElement("pre");
            faqContent.textContent = m.faqInfo.content;
            faqBox.appendChild(faqTitle);
            faqBox.appendChild(faqContent);
            div.appendChild(faqBox);
          }

          chat.appendChild(div);
        }
        chat.scrollTop = chat.scrollHeight;
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
        } catch {}
      }

      render();

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const headers = getClientAuthHeaders();
        const text = input.value.trim();
        if (!text) return;
        hideSuggestions();
        messages.push({ role: "user", content: text });
        input.value = "";
        render();
        form.querySelector('button[type="submit"]').disabled = true;
        try {
          const res = await fetch("/api/chat", {
            method: "POST",
            headers: headers,
            body: JSON.stringify({ messages }),
          });
          const data = await res.json();
          const content =
            data?.message || data?.error || "Maaf, terjadi kesalahan.";
          const products = Array.isArray(data?.products) ? data.products : [];
          const orderInfo = data?.orderInfo || null;
          const trackingInfo = data?.trackingInfo || null;
          const faqInfo = data?.faqInfo || null;
          messages.push({
            role: "assistant",
            content,
            products,
            orderInfo,
            trackingInfo,
            faqInfo,
          });
        } catch (err) {
          messages.push({
            role: "assistant",
            content: "Maaf, jaringan bermasalah.",
          });
        } finally {
          form.querySelector('button[type="submit"]').disabled = false;
          render();
        }
      });

      document.getElementById("clear").addEventListener("click", () => {
        if (confirm("Apakah Anda yakin ingin menghapus semua percakapan?")) {
          messages = defaultConversation();
          try {
            localStorage.removeItem(STORAGE_KEY);
          } catch {}
          render();
          input.focus();
        }
      });

      // Suggestion dropdown like Gemini
      const STATIC_SUGGESTIONS = [
        "Cari Daster chibi Twill",
        "Cara Retur",
        "Order Minggu ini",
      ];

      const suggestionsBox = document.createElement("div");
      suggestionsBox.className = "suggestions";
      input.parentElement.insertBefore(suggestionsBox, input.nextSibling);

      function renderSuggestions() {
        suggestionsBox.innerHTML = "";
        STATIC_SUGGESTIONS.forEach((text) => {
          const item = document.createElement("div");
          item.className = "suggestion-item";
          item.textContent = text;
          item.addEventListener("mousedown", (e) => {
            e.preventDefault();
            input.value = text;
            hideSuggestions();
            input.focus();
          });
          suggestionsBox.appendChild(item);
        });
      }

      function showSuggestions() {
        renderSuggestions();
        suggestionsBox.style.display = "block";
      }

      function hideSuggestions() {
        suggestionsBox.style.display = "none";
      }

      input.addEventListener("focus", showSuggestions);
      input.addEventListener("input", () => {
        // Tetap tampilkan saran default saat fokus; sembunyikan jika user mulai mengetik panjang
        if (input.value.length > 0) {
          showSuggestions();
        } else {
          showSuggestions();
        }
      });

      document.addEventListener("click", (e) => {
        if (!suggestionsBox.contains(e.target) && e.target !== input) {
          hideSuggestions();
        }
      });
    </script>
  </body>
</html>
